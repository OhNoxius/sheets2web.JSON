<!--<!DOCTYPE html SYSTEM "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta charset="UTF-8" />
	<title>KC ROIO</title>
	<meta name="KC Roio Archive" content="width=device-width, initial-scale=1.0" />

	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

	<!-- JQUERY -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<!-- <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script> -->
	<!-- JQUERY UI -->
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
	<script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
		integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

	<!-- DATATABLES (fixedHeader) -->
	<link rel="stylesheet" type="text/css"
		href="https://cdn.datatables.net/v/dt/dt-1.10.23/fh-3.1.7/datatables.min.css" />
	<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.23/fh-3.1.7/datatables.min.js"></script>

	<!-- TOOLTIPSTER -->
	<link rel="stylesheet" type="text/css" href="js/tooltipster/dist/css/tooltipster.bundle.min.css" />
	<script type="text/javascript" src="js/tooltipster/dist/js/tooltipster.bundle.min.js"></script>

	<!-- MOCKJAX?-->
	<script src="jquery.mockjax.min.js"></script>

	<!-- CUSTOM HELPER FUNCTIONS -->
	<script src="js/helper functions/lastUpdated.js"></script>

	<!-- CUSTOM -->
	<!-- <link rel="stylesheet" href="css/grid-linkedsheets.css" /> -->
	<link rel="stylesheet" href="css/sheet.css" />

	<script>
		//set source .xml filename
		let datafile = getFilename("json");
		//choose normal display (=false) or database mode (=true)
		//const databaseMode = true;
		//set header title to display above table
		let headerTitle = "KC ROIO";
		//set drive link to display next to header title
		let editLink = "https://docs.google.com/spreadsheets/d/1gTCRmbPqV-EL3g4KG7JdGnbVH5xIQvu0xcCTb7-JzKE/edit?usp=sharing";
		//choose character that will be used to separate content inside cells
		let delimiter = ";";
		let cashing = false; //disable cashing

		//DON'T TOUCH
		let keys = {};
		let linkedsheetTypes = new Set();
		let linkMap = new Map();
		var table, dTable, jqtable;

		////////////////////
		///SEPARATE JS/////
		//////////////////
		var jason;
		let sheets, mainsheet, linkedsheet;
		let mainsheetKeys, mainsheetKeys_vis, linkedheetKeys, linkedheetKeys_vis;
		let mainColumns = [], mainChildRowsIndexes = [], mainChildRowsHeaders = [];
		let header_row, footer_row, headerfilters_row;
		let DTCol;
		let chilrowVis = [];

		$.mockjax({
			url: "/json/data",
			dataType: "json",
			contentType: "application/json",
			proxy: "/" + datafile,
			onAfterSuccess: function (data) {
				console.log("mock success");
				//resolve(data);
			},
			onAfterError: function (error) {
				console.log("mock error");
				//reject(error);
			},
			// onAfterComplete: function () {
			// 	console.log("mock complete");
			// 	//resolve(data);
			// }
		})

		document.addEventListener('DOMContentLoaded', function () {
			table = document.getElementById("datatable");
			jqtable = $(table);
			$.ajax({
				dataType: "json",
				url: "/json/data",
				//data: data,
				success: function (data) {
					console.log("asynchronous HTTP (mockjax) request DONE");
					jason = data;

					//identify important nodes
					sheets = Object.keys(jason);
					mainsheet = sheets[0];
					linkedsheet = sheets.find(e => e.startsWith("+"));

					mainsheetKeys = Object.keys(jason[mainsheet][0]);
					mainsheetKeys_vis = mainsheetKeys.filter(el => !(el.startsWith(".") || el.startsWith("-")));
					linkedsheetKeys = Object.keys(jason[linkedsheet][0]);
					linkedsheetKeys_vis = linkedsheetKeys.filter(el => !(el.startsWith(".") || el.startsWith("-")));

					//CREATE MAP of json?
					//first create index from mainsheet					
					jason[mainsheet].forEach(function (el, key, arr) {
						linkMap.set(el[mainsheetKeys[0]], {});
					});
					//then loop through linkedsheet ONCE, and add info into above Map
					let linkItem;
					jason[linkedsheet].forEach(function (el, key, arr) {
						if (el[mainsheet]) {
							el[mainsheet].split("\n").forEach(function (linkid) {
								linkid = linkid.trim(); //POEH! Google Sheet can have hidden &#xD;
								//!!! MAYBE ALSO MAKE UPPERCASE? f.e. Return to Forever vs. Return To Forever ...
								if (linkMap.has(linkid)) {
									linkItem = linkMap.get(linkid);
									linkItem[key] = el["type"];
								}
								else {
									linkMap.set(linkid, {});
									console.log("unknown id " + linkid);
								}
							});
						}
					});

					//FORMAT JSON DATA for use in DataTables					
					header_row = table.querySelector("thead tr");
					headerfilters_row = table.querySelector("thead tr.columnfilters");
					footer_row = table.querySelector("tfoot tr");
					mainsheetKeys.forEach(function (el, key, arr) {
						//1. datatables column element
						//console.log( el.replace(/\./g, '\\\\.'));
						let keyname = el;
						if (Array.isArray(jason[mainsheet][0][el])) keyname += "[; ]";
						DTCol = {
							//"title": el,
							"data": keyname.replace(/\./g, '\\\\.'), // still doesn't work, should work...
							"visible": false
						};
						//2. HTML
						const th = document.createElement("th");
						header_row.append(th);
						headerfilters_row.append(th.cloneNode(true));
						th.append(document.createTextNode(el));

						//First element: id						
						if (Object.is(0, key)) {
							DTCol.class = "id";
							chilrowVis.push(0);
						}
						//merger columns
						else if (el.startsWith(".") || el.startsWith("-")) {
							DTCol.class = "merger";
							chilrowVis.push(0);
						}
						//child rows
						else if (el.startsWith("CE_")) {
							DTCol.class = "childrow";
							mainChildRowsIndexes.push(key);
							mainChildRowsHeaders.push(el.substring(3));
							chilrowVis.push(1);
						}
						//normal column
						else {
							DTCol.visible = true;
							chilrowVis.push(0);
						}
						mainColumns.push(DTCol);
					});

					// (?) dropdown childrow column
					if (mainChildRowsIndexes.length > 0) {
						DTCol = {
							"className": 'DTdetails',
							"orderable": false,
							"data": null,
							"defaultContent": ''
						};
						const th = document.createElement("th");
						header_row.prepend(th);
						headerfilters_row.prepend(th.cloneNode(true));
						mainColumns.unshift(DTCol);
						//chilrowVis.unshift(1);
						mainChildRowsIndexes.forEach(x => x + 1);
					}

					//Table Footer
					const th = document.createElement("th");
					const thtext = document.createTextNode("filter");
					th.setAttribute('colspan', mainColumns.length);
					th.appendChild(thtext);
					footer_row.appendChild(th);
					//mainColumns.shift(); //removes first item

					//DATATABLE
					let dataNoVis, linkedrows;
					dTable = jqtable.DataTable({
						"data": jason[mainsheet],
						"autoWidth": false,
						"order": [[1, 'asc']],
						"orderCellsTop": true,
						//"order-column": true,
						"orderClasses": false,
						"deferRender": true,
						"columns": mainColumns,
						"paging": false,
						"createdRow": function (row, data, dataIndex) {
							//if (dataIndex < 10) console.log(data[mainsheetKeys[0]]);
							//let arrMultiplied = Object.keys(data).map((x, i) => !!data[x] && chilrowVis[i])
							dataNoVis = mainsheetKeys.map((x, i) => !!data[x] && chilrowVis[i]).reduce((acc, value, index, array) => acc + value);
							linkedrows = Object.keys(linkMap.get(data[mainsheetKeys[0]])).length;
							$(row).children("td.DTdetails").text(linkedrows);
							if (dataNoVis + linkedrows > 0) {
								$(row).children("td.DTdetails").addClass('details-control');
							}
							//colummmn size...
							//$('td:not(:eq(0))', row).css('min-width', '15ex');
						},
						"fixedHeader": {
							header: true,
							footer: true
						},
						"initComplete": function () {
							//create tooltips
							//createTooltips(table);

							//COLUMN FILTERS
							this.api().columns(':visible').every(function () {
								let column = this;
								let jqth = column.header();

								//let headerText = jqth.innerText;
								//if (sheetNames.includes(column.header().innerText)) {
								let jqthisfilter = $(table).find('thead > tr.columnfilters > th').eq(column.index('visible'));
								if (jqth.classList.contains("DTdetails")) {
									//$("table.mainsheet thead tr:eq(1) th").eq(column.index()).empty();
								}
								else if (jqth.classList.contains("linkedinfo")) {
									//$("table.mainsheet thead tr:eq(1) th").eq(column.index()).empty();
									linkedsheetTypes.forEach(function (value, index, array) {
										$('<div class="nowrap"><input type="checkbox" id="' + jqth.innerText + value + '" name="' + jqth.innerText + '" value="' + value + '" class="headercheckbox" />' +
											'<label for="' + jqth.innerText + value + '">' + value + '</label></div>')
											.appendTo(jqthisfilter);
									});
									//$("table.mainsheet thead tr:eq(1) th").attr("colspan", "2");
									$('input:checkbox').on('change', function (e) {
										//build a regex filter string with an or(|) condition
										let checkboxes = $('input:checkbox:checked').map(function () {
											return this.value;
										}).get().join('|');
										//filter in column 1, with an regex, no smart filtering, not case sensitive
										column.search(checkboxes, true, false, false).draw(false);
									});
									dropdowns.set(column.index(), linkedsheetTypes);
								}
								else {
									let input = $('<input type="search" size="10" autocomplete="off" list="' + jqth.innerText + '-list" id="' + jqth.innerText + '-input" name="' + jqth.innerText + '" class="headersearch" />'
									)//+ '<datalist id="' + th.innerText + '-list"></datalist>')
										//.appendTo($(column.footer()).empty())
										.appendTo(jqthisfilter)
										.on('change search', function () {
											if (column.search() !== this.value) {
												column
													.search(this.value)
													.draw('page');
											}
										});

									let ARR = column.data().unique().toArray();
									const delims = /([:+\r\n]+)|((?<!\s)\()/g
									let temp = ARR.join(delimiter).replace(delims, ";");
									ARR = temp.split(delimiter);
									ARR.forEach((o, i, a) => a[i] = a[i].trim());
									let SET = new Set(ARR);
									ARR = [...SET].sort();

									//OPTION 1: HTML5 datalists
									//column.data().unique().sort().each(function (d, j) {
									let datalist = $('<datalist id="' + jqth.innerText + '-list"></datalist>').insertAfter($(input));
									ARR.forEach(function (val) {
										datalist.append('<option value="' + val + '" />')
									});
									//OPTION 2: jQuery UI autocomplete (see xml code)
								}
								//}
							});
						}
					});

					jqtable.children('tbody').on('click', 'td.details-control', function () {
						let jqtr = $(this).closest('tr');
						let dRow = dTable.row(jqtr);

						//select data (columns) that are hidden
						let idx = mainChildRowsIndexes.map(x => x + 1);
						let cells = dTable.cells(dRow, idx);

						//format that data into a new table
						let title = "", details = "", detailsTable = "";
						for (let i = 0; i < cells.data().length; i++) {
							if (cells.data()[i]) details += format(mainChildRowsHeaders[i], cells.data()[i]);
						}
						if (details != "") detailsTable = '<table class="detailsTable">' + details + '</table>';

						if (dRow.child.isShown()) {
							// This row is already open - close it
							dRow.child.hide();
							jqtr.removeClass('shown');
						}
						else {
							// Open this row
							dRow.child(detailsTable).show();
							jqtr.addClass('shown');
						}
					});
				}
			});
		});

		function format(h, d) {
			// `d` is the original data object for the row
			return '<tr class="detailsRow">' +
				'<td class="detailsHeader">' + h + ':</td>' +
				'<td>' + d + '</td>' +
				'</tr>'
		}
	</script>
</head>

<body>
	<header>
		<div id="heading"></div>
		<div id="status">
			<!-- <label for="statusBar">Loading xml:</label>
			<progress id="statusBar"></progress> -->
		</div>
		<div id="activity"></div>
		<!-- <div id="filters"></div> -->
	</header>
	<nav>
		<div id="menu"></div>
	</nav>
	<section>
		<div id="results">
			<table id="datatable" class="display" width="100%">
				<thead>
					<tr></tr>
					<tr class="columnfilters"></tr>
				</thead>
				<tbody></tbody>
				<tfoot>
					<tr></tr>
				</tfoot>
			</table>
		</div>
	</section>
</body>

</html>